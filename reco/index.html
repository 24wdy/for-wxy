<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é”™è¯¯è®°å½• | å°æ¬£æ‚¦çš„ä¸ªæ€§åŒ–å­¦ä¹ å¹³å°</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .records-container {
      width: 100%;
      max-width: 800px;
      margin: 2rem auto;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      padding: 2rem;
    }
    .action-buttons { display: flex; gap: 1rem; justify-content: center; margin: 2rem 0; }
.btn { padding: 0.8rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 0.5rem; transition: transform 0.2s, box-shadow 0.2s; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.primary-btn { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
.secondary-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
.stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem auto; max-width: 1000px; padding: 0 1rem; }
.stat-card { background-color: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; }
.score-value { font-size: 2.5rem; font-weight: bold; color: #e74c3c; margin: 0.5rem 0; }
.batch-list { margin-top: 1rem; }
.batch-item { background-color: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; }
.records-section { background-color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 1.5rem; margin: 0 auto 2rem; max-width: 1000px; }
.section-header { padding-bottom: 1rem; border-bottom: 1px solid #f0f0f0; margin-bottom: 1rem; }
.record-item {
      padding: 1.2rem;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
    }
    .record-item:last-child {
      border-bottom: none;
    }
    .record-item:hover {
      background-color: #f9f9f9;
    }
    .record-item { padding: 1.2rem; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s ease, transform 0.2s; }
.record-item:hover { background-color: #f9f9f9; transform: translateX(5px); }
.record-question {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }
    .record-date { color: #7f8c8d; font-size: 0.85rem; margin-bottom: 0.5rem; }
.record-solution {
      color: #3498db;
      font-size: 0.95rem;
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #7f8c8d;
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
    }
    .modal-content { max-width: 500px; width: 90%; margin: 2rem auto; padding: 2rem; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); background-color: white; position: relative; }
    .form-group { margin-bottom: 1.2rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
    .submit-btn { width: 100%; padding: 0.8rem; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 1rem; }
    .modal-content h2 { margin-top: 0; margin-bottom: 1.5rem; }
  </style>
</head>
<body>
  <header class="main-header">
    <h1 class="title">é”™è¯¯è®°å½•</h1>
    <p class="subtitle">æ¸©æ•…çŸ¥æ–°ï¼ŒæŸ¥æ¼è¡¥ç¼º</p>
  </header>
  

  
  <div class="action-buttons">
      <button id="add-record-btn" class="btn primary-btn"><i class="icon">â•</i> è®°å½•æ–°é”™è¯¯</button>
      <button id="archive-btn" class="btn secondary-btn"><i class="icon">ğŸ“¦</i> å½’æ¡£è®°å½•</button>
    </div>

  <!-- æ·»åŠ é”™è¯¯è®°å½•çš„æ¨¡æ€æ¡† -->
  <div id="error-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>è®°å½•æ–°é”™è¯¯</h2>
      <form id="error-form">
        <div class="form-group">
          <label for="error-type">é”™è¯¯ç±»å‹:</label>
          <select id="error-type" required>
            <option value="">è¯·é€‰æ‹©é”™è¯¯ç±»å‹</option>
            <option value="basic">åŸºç¡€ä¸æ‰å®</option>
            <option value="mentality">å¿ƒæ€é—®é¢˜</option>
            <option value="time">æ—¶é—´è§„åˆ’</option>
            <option value="schedule">ä½œæ¯é—®é¢˜</option>
            <option value="st">å®¡é¢˜</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="error-description">å…·ä½“æè¿°:</label>
          <textarea id="error-description" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="error-date">é”™è¯¯æ—¶é—´:</label>
          <input type="date" id="error-date" required>
        </div>
        
        <div class="form-group">
          <label for="point-rule">æ‰£é™¤ç§¯åˆ†è§„åˆ™:</label>
          <select id="point-rule" required>
            <option value="add">ç´¯åŠ </option>
            <option value="multiply">ç´¯ä¹˜</option>
            <option value="function1">å‡½æ•°1</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="coefficient">æ‰£é™¤ç§¯åˆ†ç³»æ•°:</label>
          <input type="number" id="coefficient" step="0.01" min="0.01" required>
        </div>
        
        <button type="submit" class="submit-btn">ä¿å­˜è®°å½•</button>
      </form>
    </div>
  </div>
  
  <!-- å½’æ¡£å¯†ç æ¨¡æ€æ¡† -->
  <div id="archive-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>ç¡®è®¤å½’æ¡£</h2>
      <p>è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥:</p>
      <input type="password" id="admin-key" required>
      <button id="confirm-archive" class="submit-btn">ç¡®è®¤å½’æ¡£</button>
    </div>
  </div>
  
  <!-- æ‰£åˆ†ç»Ÿè®¡ -->
  <div class="stats-container">
    <div class="stat-card">
      <h3>æœªå½’æ¡£æ€»æ‰£åˆ†</h3>
      <p id="unarchived-score" class="score-value">0</p>
    </div>
    <div class="stat-card">
      <h3>å·²å½’æ¡£æ‰¹æ¬¡</h3>
      <div id="archive-batches" class="batch-list"></div>
    </div>
  </div>
  
  <div class="records-section">
    <div class="section-header">
      <h2>æœªå½’æ¡£é”™è¯¯è®°å½•</h2>
    </div>
    <div id="unarchived-records" class="record-list"></div>
  </div>

  <div class="records-section">
    <div class="section-header">
      <h2>å·²å½’æ¡£é”™è¯¯è®°å½•</h2>
    </div>
    <div id="archived-records" class="record-list"></div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabaseåˆå§‹åŒ–
    const supabaseUrl = 'https://uqxhnjdckqyathfuvnsb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxeGhuamRja3F5YXRoZnV2bnNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjM1MTksImV4cCI6MjA2NzYzOTUxOX0.eIKLbQJK7UgwWR3dP_kzqMdaWR_ys7PtGIy83_0c628';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    // DOMå…ƒç´ 
    const addRecordBtn = document.getElementById('add-record-btn');
    const errorModal = document.getElementById('error-modal');
    const archiveModal = document.getElementById('archive-modal');
    const closeBtns = document.querySelectorAll('.close-btn');
    const errorForm = document.getElementById('error-form');
    const archiveBtn = document.getElementById('archive-btn');
    const confirmArchiveBtn = document.getElementById('confirm-archive');
    const unarchivedRecords = document.getElementById('unarchived-records');
    const archivedRecords = document.getElementById('archived-records');
    const unarchivedScore = document.getElementById('unarchived-score');
    const archiveBatches = document.getElementById('archive-batches');
    const adminKeyInput = document.getElementById('admin-key');
    
    // ç®¡ç†å‘˜å¯†é’¥ (å®é™…åº”ç”¨ä¸­åº”è¯¥å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯)
    const ADMIN_KEY = 'admin123';
    
    // æ¨¡æ€æ¡†æ§åˆ¶
    addRecordBtn.addEventListener('click', () => {
      errorModal.style.display = 'flex';
      // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
      document.getElementById('error-date').valueAsDate = new Date();
    });
    
    archiveBtn.addEventListener('click', () => {
      archiveModal.style.display = 'flex';
      adminKeyInput.value = '';
    });
    
    closeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        errorModal.style.display = 'none';
        archiveModal.style.display = 'none';
      });
    });
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.addEventListener('click', (e) => {
      if (e.target === errorModal) errorModal.style.display = 'none';
      if (e.target === archiveModal) archiveModal.style.display = 'none';
    });
    
    // è¡¨å•æäº¤å¤„ç†
    errorForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const errorType = document.getElementById('error-type').value;
      const description = document.getElementById('error-description').value;
      const errorDate = document.getElementById('error-date').value;
      const pointRule = document.getElementById('point-rule').value;
      const coefficient = parseFloat(document.getElementById('coefficient').value);
      
      // ä¿å­˜é”™è¯¯è®°å½•åˆ°Supabase
      const { data, error } = await supabaseClient
        .from('error_records')
        .insert([
          {
            error_type: errorType,
            description: description,
            error_date: errorDate,
            point_rule: pointRule,
            coefficient: coefficient,
            is_archived: false
          }
        ]);
      
      if (error) {
        console.error('ä¿å­˜é”™è¯¯è®°å½•å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
      } else {
        errorModal.style.display = 'none';
        errorForm.reset();
        alert('é”™è¯¯è®°å½•ä¿å­˜æˆåŠŸ!');
        loadErrorRecords(); // é‡æ–°åŠ è½½è®°å½•
      }
    });
    
    // å½’æ¡£å¤„ç†
    confirmArchiveBtn.addEventListener('click', async () => {
      const adminKey = adminKeyInput.value;
      if (adminKey !== ADMIN_KEY) {
        alert('ç®¡ç†å‘˜å¯†é’¥ä¸æ­£ç¡®');
        return;
      }
      
      // è·å–æœªå½’æ¡£è®°å½•
      const { data: unarchivedData, error: fetchError } = await supabaseClient
        .from('error_records')
        .select('*')
        .eq('is_archived', false);
      
      if (fetchError || !unarchivedData.length) {
        alert('æ²¡æœ‰å¯å½’æ¡£çš„è®°å½•');
        return;
      }
      
      // è·å–æœ€æ–°æ‰¹æ¬¡å·
      const { data: batchData, error: batchError } = await supabaseClient
        .from('archive_batches')
        .select('batch_number')
        .order('batch_number', { ascending: false })
        .limit(1);
      
      const batchNumber = batchData.length ? batchData[0].batch_number + 1 : 1;
      
      // è®¡ç®—æ€»æ‰£åˆ†
      const totalScore = calculateTotalScore(unarchivedData);
      
      // åˆ›å»ºå½’æ¡£æ‰¹æ¬¡
      const { data: newBatch, error: batchInsertError } = await supabaseClient
        .from('archive_batches')
        .insert([
          {
            batch_number: batchNumber,
            archive_date: new Date().toISOString(),
            total_score: totalScore
          }
        ])
        .select();
      
      if (batchInsertError) {
        console.error('åˆ›å»ºå½’æ¡£æ‰¹æ¬¡å¤±è´¥:', batchInsertError);
        alert('å½’æ¡£å¤±è´¥: ' + batchInsertError.message);
        return;
      }
      
      // æ›´æ–°è®°å½•ä¸ºå·²å½’æ¡£
      const { error: updateError } = await supabaseClient
        .from('error_records')
        .update({
          is_archived: true,
          archive_batch_id: newBatch[0].id
        })
        .eq('is_archived', false);
      
      if (updateError) {
        console.error('æ›´æ–°å½’æ¡£çŠ¶æ€å¤±è´¥:', updateError);
        alert('å½’æ¡£å¤±è´¥: ' + updateError.message);
        return;
      }
      
      archiveModal.style.display = 'none';
      alert(`æˆåŠŸå½’æ¡£ ${unarchivedData.length} æ¡è®°å½•ï¼Œæ‰¹æ¬¡å·: ${batchNumber}`);
      loadErrorRecords();
      loadArchiveBatches();
    });
    
    // è®¡ç®—æ€»æ‰£åˆ†
    function calculateTotalScore(records) {
      let addSum = 0;
      let multiplySum = 0;
      let function1Sum = 0;
      
      records.forEach(record => {
        if (record.point_rule === 'add') {
          addSum += record.coefficient;
        } else if (record.point_rule === 'multiply'){
          multiplySum += record.coefficient;
        } else {
          function1Sum += record.coefficient;
        }
      });
      const function1Result = (3/2)*(Math.sin((Math.PI/2) *function1Sum)+Math.sin(Math.PI*function1Sum)+function1Sum)^(4/5);
      const multiplyResult = Math.pow(1.8, multiplySum);
      return Math.ceil(addSum + multiplyResult + function1Result);
    }
    
    // åŠ è½½é”™è¯¯è®°å½•
    async function loadErrorRecords() {
      // åŠ è½½æœªå½’æ¡£è®°å½•
      const { data: unarchivedData, error: unarchivedError } = await supabaseClient
        .from('error_records')
        .select('*')
        .eq('is_archived', false)
        .order('error_date', { ascending: false });
      
      if (unarchivedError) {
        console.error('åŠ è½½æœªå½’æ¡£è®°å½•å¤±è´¥:', unarchivedError);
      } else if (unarchivedData.length) {
        unarchivedRecords.innerHTML = unarchivedData.map(record => createRecordElement(record)).join('');
        unarchivedScore.textContent = calculateTotalScore(unarchivedData);
      } else {
        unarchivedRecords.innerHTML = `
          <div class="empty-state">
            <i>ğŸ“Š</i>
            <h3>æš‚æ— æœªå½’æ¡£é”™è¯¯è®°å½•</h3>
            <p>ç‚¹å‡»"è®°å½•æ–°é”™è¯¯"æŒ‰é’®æ·»åŠ è®°å½•</p>
          </div>
        `;
        unarchivedScore.textContent = '0';
      }
      
      // åŠ è½½å·²å½’æ¡£è®°å½•
      const { data: archivedData, error: archivedError } = await supabaseClient
        .from('error_records')
        .select('*, archive_batches(batch_number)')
        .eq('is_archived', true)
        .order('error_date', { ascending: false });
      
      if (archivedError) {
        console.error('åŠ è½½å·²å½’æ¡£è®°å½•å¤±è´¥:', archivedError);
      } else if (archivedData.length) {
        archivedRecords.innerHTML = archivedData.map(record => createRecordElement(record, true)).join('');
      } else {
        archivedRecords.innerHTML = `
          <div class="empty-state">
            <i>ğŸ“¦</i>
            <h3>æš‚æ— å·²å½’æ¡£é”™è¯¯è®°å½•</h3>
            <p>å°†æœªå½’æ¡£è®°å½•å½’æ¡£åæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½å½’æ¡£æ‰¹æ¬¡
    async function loadArchiveBatches() {
      const { data: batches, error } = await supabaseClient
        .from('archive_batches')
        .select('*')
        .order('batch_number', { ascending: false });
      
      if (error) {
        console.error('åŠ è½½å½’æ¡£æ‰¹æ¬¡å¤±è´¥:', error);
      } else if (batches.length) {
        archiveBatches.innerHTML = batches.map(batch => `
          <div class="batch-item">
            <p>æ‰¹æ¬¡ ${batch.batch_number}: ${batch.total_score} åˆ†</p>
            <small>${new Date(batch.archive_date).toLocaleDateString()}</small>
          </div>
        `).join('');
      } else {
        archiveBatches.innerHTML = '<p>æš‚æ— å½’æ¡£æ‰¹æ¬¡</p>';
      }
    }
    
    // åˆ›å»ºè®°å½•å…ƒç´ 
    function createRecordElement(record, isArchived = false) {
      const errorTypes = {
        'basic': 'åŸºç¡€ä¸æ‰å®',
        'mentality': 'å¿ƒæ€é—®é¢˜',
        'time': 'æ—¶é—´è§„åˆ’',
        'schedule': 'ä½œæ¯é—®é¢˜',
        'st': 'å®¡é¢˜'
      };
      
      const ruleTypes = {
        'add': 'ç´¯åŠ ',
        'multiply': 'ç´¯ä¹˜',
        'function1': 'å‡½æ•°1'
      };
      
      return `
        <div class="record-item">
          <div class="record-question">
            ${errorTypes[record.error_type]} (${ruleTypes[record.point_rule]}: ${record.coefficient})
            ${isArchived ? `<span class="archive-badge">æ‰¹æ¬¡ ${record.archive_batches.batch_number}</span>` : ''}
          </div>
          <div class="record-date">${new Date(record.error_date).toLocaleDateString()}</div>
          <div class="record-solution">${record.description}</div>
        </div>
      `;
    }
    
    // é¡µé¢åŠ è½½æ—¶åŠ è½½æ•°æ®
    window.addEventListener('DOMContentLoaded', () => {
      loadErrorRecords();
      loadArchiveBatches();
    });
  </script>
</body>
</html>